<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
    }
    form {
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    div.text-right {
      position: fixed;
      top: 20px;
      right: 20px; 
    }
  </style>
</head>
<body>
  <h1>Expense Tracker</h1>
  <form id="expenseForm" class="form-inline">
    <div class="form-group mr-3">
      <label for="amount">Expense Amount:</label>
      <input type="number" name="amount" id="amount" class="form-control" required>
    </div>

    <div class="form-group mr-3">
      <label for="description">Expense Description:</label>
      <input type="text" name="description" id="description" class="form-control" required>
    </div>

    <div class="form-group mr-3">
      <label for="category">Expense Category:</label>
      <select id="category" name="category" class="form-control">
        <option value="Salary">Salary</option>
        <option value="Travelling">Travelling</option>
        <option value="Shopping">Shopping</option>
        <option value="Food">Food</option>
      </select>
    </div>
    

    <button type="submit" class="btn btn-primary">Add Expense</button>
  </form>

  <h2>Expense List</h2>
  <table>
    <thead>
      <tr>
        <th>Amount</th>
        <th>Description</th>
        <th>Category</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="listOfExpensesTable"></tbody>
  </table>
  <div id="premiumMessage"></div>
  <div id="leaderboard"></div>
   
   <div class="text-right mb-3">
    <button class="btn btn-primary" id="rzp-button">Buy Premium</button>
  </div>
  
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
  
  
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  

  <script>
    const form = document.getElementById('expenseForm');
    const listOfExpensesTable = document.getElementById('listOfExpensesTable');

    form.addEventListener('submit', addNewExpense);

    function addNewExpense(event) {
      event.preventDefault();

      const expenseDetails = {
        amount: document.getElementById('amount').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
      };

      const token = localStorage.getItem('token'); 

      axios.post('http://localhost:3000/expense/addexpense', expenseDetails, {
        headers: { 'Authorization': token }
      })
        .then(response => {
          addNewExpenseToUI(response.data.expense);
        })
        .catch(err => {
          showError(err);
          console.log(err.response.data);
        });
    }


    function addNewExpenseToUI(expense) {
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${expense.amount}</td>
        <td>${expense.description}</td>
        <td>${expense.category}</td>
        <td><button onclick="deleteExpense(${expense.id})">Delete Expense</button></td>
      `;
      newRow.dataset.id = expense.id;
      listOfExpensesTable.appendChild(newRow);
    }

    function deleteExpense(expenseId) {
      const token = localStorage.getItem('token'); 

      axios.delete(`http://localhost:3000/expense/deleteexpense/${expenseId}`, {
        headers: { 'Authorization': token }
      })
        .then(response => {
          removeExpenseFromUI(expenseId);
        })
        .catch(err => showError(err));
    }

    

    function removeExpenseFromUI(expenseId) {
      const expenseRow = listOfExpensesTable.querySelector(`tr[data-id="${expenseId}"]`);
      if (expenseRow) {
        expenseRow.remove();
      }
    }
 function showPremiumMessage(){
      document.getElementById('premiumMessage').innerHTML = 'You are a premium user';
      document.getElementById('rzp-button').style.visibility = 'hidden';

    }
    function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
  
      return JSON.parse(jsonPayload);
  }
    function loadExpenses() {
      const token = localStorage.getItem('token');
      const decodeToken=parseJwt(token) 
      console.log(decodeToken)
      const ispremiumuser=decodeToken.ispremiumuser
      if(ispremiumuser){
        showPremiumMessage()

      }
      axios.get('http://localhost:3000/expense/getexpenses', {
        headers: { 'Authorization': token }
      })
        .then(response => {
          response.data.expenses.forEach(expense => {
            addNewExpenseToUI(expense);
          });
        })
        .catch(err => {
          showError(err);
          console.log(err.response.data); 
        });
    }

    loadExpenses(); 

    function showLeaderboard() {
      const token = localStorage.getItem('token');
      const decodeToken = parseJwt(token);
      const isPremiumUser = decodeToken.ispremiumuser;
    
      if (isPremiumUser) {
        const inputElement = document.createElement("input");
        inputElement.type = "button";
        inputElement.value = "Show leaderboard";
        inputElement.onclick = async () => {
          try {
            const userLeaderArray = await axios.get('http://localhost:3000/premium/showLeaderBoard', {
              headers: { 'Authorization': token }
            });
            console.log(userLeaderArray);
    
            var leaderboardElem = document.getElementById('leaderboard');
            leaderboardElem.innerHTML = '<h1>Leader Board</h1>';
    
            userLeaderArray.data.forEach((userDetails) => {
              leaderboardElem.innerHTML += `<li>Name - ${userDetails.name} Total Expense - ${userDetails.totalexpenses || 0}</li>`;
              console.log(userDetails)
            });
          } catch (error) {
            console.error("Error fetching leaderboard:", error);
          }
        };
        document.getElementById("premiumMessage").appendChild(inputElement);
      }
    }
    
    showLeaderboard();
    
    
  

    function showError(err) {
      console.error(err);
    }
   
    

    document.getElementById('rzp-button').onclick = async function (e) {
     
      const token = localStorage.getItem('token');
      console.log('Token:', token);
    
      const response = await axios.get('http://localhost:3000/purchase/premiummembership', {
          headers: { 'Authorization': token }
        });
        console.log('Response:', response);
       var options={
          "key":response.data.key_id,
          "order_id":response.data.order.id,
         "handler": async function (response) {
              await axios.post(
                'http://localhost:3000/purchase/updatetransactionstatus',
                {
                  order_id: options.order_id,
                  payment_id: response.razorpay_payment_id,
                },
                {
                  headers: { "Authorization": token },
                  
                }
              );

            
              
              alert("You are a Premium User Now");
              document.getElementById('rzp-button').style.visibility = 'hidden';
              document.getElementById('premiumMessage').innerHTML = 'You are a premium user';

              localStorage.setItem('token',response.data.token);
            },
          };
          
          var rzp = new Razorpay(options);
          rzp.open();
          e.preventDefault();
    
          rzp.on('payment.failed', function (response) {
            console.log(response);
            alert("Something went wrong");
         
          });
        }
        
        
        </script>
</body>
</html>
